<!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ”¹ä¸ºè¯­éŸ³è¾“å…¥åŒºåŸŸ -->
<view class="upload-section" wx:if="{{!hasUploaded}}">
  <view class="section-title">
    <view class="icon">ğŸ¤</view>
    <text class="title-text">è¯­éŸ³èƒŒè¯µå½•éŸ³</text>
  </view>
  
  <!-- è¯­éŸ³å½•åˆ¶åŒºåŸŸ -->
  <view class="recording-section">
    <view class="recording-status">
      <view class="recording-icon {{isRecording ? 'pulse' : ''}}">
        {{isRecording ? 'ğŸ”´' : 'âšª'}}
      </view>
      <view class="recording-text">
        {{isRecording ? 'å½•éŸ³ä¸­...' : 'ç‚¹å‡»å¼€å§‹å½•éŸ³'}}
      </view>
      <view class="recording-time" wx:if="{{isRecording}}">
        {{formatTime(recordingTime)}}
      </view>
    </view>
    
    <!-- å½•éŸ³æ§åˆ¶æŒ‰é’® -->
    <view class="recording-controls">
      <button 
        class="btn {{isRecording ? 'btn-stop' : 'btn-record'}}" 
        bindtap="{{isRecording ? 'stopRecording' : 'startRecording'}}"
        disabled="{{isRecording && recordingTime < 3}}"
      >
        <text>{{isRecording ? 'åœæ­¢å½•éŸ³' : 'å¼€å§‹å½•éŸ³'}}</text>
        <view class="btn-icon">{{isRecording ? 'â¹ï¸' : 'ğŸ¤'}}</view>
      </button>
      
      <button 
        class="btn btn-play" 
        bindtap="playRecording" 
        disabled="{{!audioFilePath || isRecording}}"
        wx:if="{{audioFilePath && !isRecording}}"
      >
        <text>æ’­æ”¾å½•éŸ³</text>
        <view class="btn-icon">â–¶ï¸</view>
      </button>
    </view>
    
    <!-- å½•éŸ³æ³¢å½¢æ˜¾ç¤º -->
    <view class="waveform" wx:if="{{isRecording}}">
      <view 
        class="wave-bar" 
        wx:for="{{waveformData}}" 
        wx:key="index"
        style="height: {{item}}rpx;"
      ></view>
    </view>
  </view>
  
  <!-- å½•éŸ³æ–‡ä»¶ä¿¡æ¯ -->
  <view class="recording-info" wx:if="{{audioFilePath && !isRecording}}">
    <view class="info-item">
      <text class="label">å½•éŸ³æ—¶é•¿ï¼š</text>
      <text class="value">{{formatTime(recordingTime)}}</text>
    </view>
    <view class="info-item">
      <text class="label">æ–‡ä»¶å¤§å°ï¼š</text>
      <text class="value">{{audioFileSize}} KB</text>
    </view>
    <view class="info-item">
      <text class="label">å½•éŸ³æ—¶é—´ï¼š</text>
      <text class="value">{{recordingTimestamp}}</text>
    </view>
  </view>
  
  <!-- å¤è¯—é€‰æ‹© -->
  <view class="poem-selector">
    <view class="section-title">
      <view class="icon">ğŸ“œ</view>
      <text class="title-text">é€‰æ‹©å¤è¯—</text>
    </view>
    <picker bindchange="onPoemChange" value="{{poemIndex}}" range="{{poemList}}" range-key="name">
      <view class="picker">
        <text class="picker-label">å½“å‰é€‰æ‹©ï¼š</text>
        <text class="picker-value">{{poemList[poemIndex].name}}</text>
        <view class="picker-arrow">â–¼</view>
      </view>
    </picker>
  </view>
  
  <!-- ä¸Šä¼ æŒ‰é’® -->
  <button class="btn btn-primary upload-btn" bindtap="uploadAndEvaluate" disabled="{{!audioFilePath}}">
    <text>ä¸Šä¼ å¹¶è·å–ç‚¹è¯„</text>
    <view class="btn-icon">ğŸš€</view>
  </button>
</view>

<!-- éŸ³é¢‘æ–‡ä»¶åˆ—è¡¨æ”¹ä¸ºå½•éŸ³æ–‡ä»¶æ˜¾ç¤º -->
<view class="audio-section" wx:if="{{hasUploaded && !loading && !error}}">
  <view class="section-title">
    <view class="icon">ğŸ§</view>
    <text class="title-text">å½•éŸ³æ–‡ä»¶</text>
  </view>
  <view class="audio-list">
    <view class="audio-item">
      <view class="audio-icon">ğŸ¤</view>
      <view class="audio-info">
        <text class="audio-name">è¯­éŸ³èƒŒè¯µå½•éŸ³</text>
        <text class="audio-duration">{{formatTime(recordingTime)}}</text>
      </view>
      <view class="play-btn" bindtap="playRecording">â–¶</view>
    </view>
  </view>
  
  <!-- ç‚¹è¯„ç»“æœå±•ç¤º -->
  <view class="evaluation-section">
    <view class="section-title">
      <view class="icon">ğŸ“</view>
      <text class="title-text">AIç‚¹è¯„ç»“æœ</text>
    </view>
    
    <view class="evaluation-content">
      <!-- æ€»ä½“è¯„åˆ† -->
      <view class="evaluation-item">
        <view class="evaluation-label">æ€»ä½“è¯„åˆ†ï¼š</view>
        <view class="evaluation-text">{{overallScore}}åˆ†</view>
      </view>
      
      <!-- è¯¦ç»†è¯„åˆ† -->
      <view class="evaluation-item">
        <view class="evaluation-label">è¯¦ç»†è¯„åˆ†ï¼š</view>
        <view class="detail-scores">
          <view class="detail-item">
            <view class="detail-value">{{detailedScores.content_completeness}}</view>
            <view class="detail-label">å†…å®¹å®Œæ•´åº¦</view>
          </view>
          <view class="detail-item">
            <view class="detail-value">{{detailedScores.structural_correctness}}</view>
            <view class="detail-label">ç»“æ„æ­£ç¡®æ€§</view>
          </view>
          <view class="detail-item">
            <view class="detail-value">{{detailedScores.key_imagery_preservation}}</view>
            <view class="detail-label">å…³é”®æ„è±¡ä¿ç•™</view>
          </view>
        </view>
      </view>
      
      <!-- ä¸»è¦é”™è¯¯ -->
      <view class="evaluation-item" wx:if="{{majorErrors.length > 0}}">
        <view class="evaluation-label">ä¸»è¦é”™è¯¯ï¼š</view>
        <view class="error-list">
          <view class="error-item" wx:for="{{majorErrors}}" wx:key="index">
            <view class="error-header">
              <view class="error-type">{{item.error_type}}</view>
              <view class="severity {{item.severity}}">{{item.severity}}</view>
            </view>
            <view class="error-detail">
              <text class="label">ä½ç½®ï¼š</text>
              <text class="value">{{item.position}}</text>
            </view>
            <view class="error-detail">
              <text class="label">ç¼ºå¤±å†…å®¹ï¼š</text>
              <text class="value">{{item.missing_content}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- è¡¨æ‰¬ -->
      <view class="evaluation-item">
        <view class="evaluation-label">è¡¨æ‰¬ï¼š</view>
        <view class="evaluation-text">{{feedback.praise}}</view>
      </view>
      
      <!-- æ”¹è¿›å»ºè®® -->
      <view class="evaluation-item">
        <view class="evaluation-label">æ”¹è¿›å»ºè®®ï¼š</view>
        <view class="evaluation-suggestions">
          <block wx:for="{{feedback.suggestions}}" wx:key="index">
            <view class="suggestion-item">
              <text class="suggestion-index">{{index + 1}}.</text>
              <text class="suggestion-text">{{item}}</text>
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>
  
  <!-- é‡æ–°ä¸Šä¼ æŒ‰é’® -->
  <view class="reupload-section">
    <button class="btn btn-reupload" bindtap="reUpload">
      <text>é‡æ–°èƒŒè¯µå¹¶ä¸Šä¼ </text>
      <view class="btn-icon">ğŸ”„</view>
    </button>
  </view>
</view>

<!-- æ–°å¢ï¼šèƒŒè¯µè®°å½•æŒ‰é’® -->
<view class="records-btn-container">
  <button class="btn btn-records" bindtap="showReciteRecords">
    <text>æŸ¥çœ‹èƒŒè¯µè®°å½•</text>
    <view class="btn-icon">ğŸ“Š</view>
  </button>
</view>

<!-- æ–°å¢ï¼šèƒŒè¯µè®°å½•å¼¹çª— -->
<view class="records-modal" wx:if="{{showRecordsModal}}">
  <view class="records-modal-content">
    <view class="records-header">
      <text class="records-title">èƒŒè¯µè®°å½•</text>
      <view class="records-actions">
        <text class="refresh-btn" bindtap="refreshRecords">åˆ·æ–°</text>
        <text class="close-btn" bindtap="hideReciteRecords">Ã—</text>
      </view>
    </view>
    
    <!-- è®°å½•åˆ—è¡¨ -->
    <view wx:if="{{!selectedRecord}}" class="records-list">
      <view wx:if="{{recordsLoading}}" class="records-loading">
        <text>åŠ è½½ä¸­...</text>
      </view>
      
      <view wx:elif="{{reciteRecords && reciteRecords.length === 0}}" class="records-empty">
        <text class="empty-text">æš‚æ— èƒŒè¯µè®°å½•</text>
        <text class="empty-desc">å®Œæˆä¸€æ¬¡èƒŒè¯µåï¼Œè®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
      </view>
      
      <scroll-view wx:else class="records-scroll" scroll-y>
        <view wx:for="{{reciteRecords}}" wx:key="id" class="record-item" bindtap="viewRecordDetail" data-id="{{item.id}}">
          <view class="record-header">
            <text class="record-score {{item.overallScore >= 80 ? 'good' : item.overallScore >= 60 ? 'medium' : 'poor'}}">
              è¯„åˆ†: {{item.overallScore}}
            </text>
            <text class="record-time">{{item.displayTime || formatDisplayTime(item.createdAt)}}</text>
          </view>
          <view class="record-feedback">
            <text class="feedback-text">{{item.praiseFeedback || 'æš‚æ— åé¦ˆ'}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
    
    <!-- è®°å½•è¯¦æƒ… -->
    <view wx:if="{{selectedRecord}}" class="record-detail">
      <view class="detail-header">
        <text class="back-btn" bindtap="backToRecordList">â€¹ è¿”å›</text>
        <text class="detail-title">èƒŒè¯µè¯¦æƒ…</text>
      </view>
      
      <scroll-view class="detail-content" scroll-y>
        <view class="detail-section">
          <text class="section-label">ç»¼åˆè¯„åˆ†</text>
          <text class="section-value score-{{selectedRecord.overallScore >= 80 ? 'good' : selectedRecord.overallScore >= 60 ? 'medium' : 'poor'}}">
            {{selectedRecord.overallScore}}åˆ†
          </text>
        </view>
        
        <view class="detail-section">
          <text class="section-label">è¡¨æ‰¬åé¦ˆ</text>
          <text class="section-value praise">{{selectedRecord.praiseFeedback || 'æš‚æ— è¡¨æ‰¬åé¦ˆ'}}</text>
        </view>
        
        <view wx:if="{{selectedRecord.majorErrors && selectedRecord.majorErrors.length > 0}}" class="detail-section">
          <text class="section-label">ä¸»è¦é”™è¯¯</text>
          <view wx:for="{{selectedRecord.majorErrors}}" wx:key="index" class="error-item">
            <text class="error-position">{{item.position || 'æœªçŸ¥ä½ç½®'}}</text>
            <text class="error-type {{item.severity === 'ä¸¥é‡' ? 'severe' : 'normal'}}">
              {{item.error_type || 'æœªçŸ¥é”™è¯¯ç±»å‹'}} ({{item.severity || 'æœªçŸ¥ä¸¥é‡ç¨‹åº¦'}})
            </text>
            <text class="error-desc">{{item.missing_content || 'æœªçŸ¥ç¼ºå¤±å†…å®¹'}}</text>
          </view>
        </view>
        
        <view wx:if="{{selectedRecord.suggestions && selectedRecord.suggestions.length > 0}}" class="detail-section">
          <text class="section-label">æ”¹è¿›å»ºè®®</text>
          <view wx:for="{{selectedRecord.suggestions}}" wx:key="index" class="suggestion-item">
            <text class="suggestion-text">{{item}}</text>
          </view>
        </view>
        
        <view class="detail-section">
          <text class="section-label">èƒŒè¯µæ—¶é—´</text>
          <text class="section-value time">{{selectedRecord.displayTime || formatDisplayTime(selectedRecord.createdAt)}}</text>
        </view>
      </scroll-view>
    </view>
  </view>
</view>